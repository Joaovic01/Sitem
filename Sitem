<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Simulador de Empr√©stimo Online ‚Äî Parcelas, Juros e Tabela (Price)</title>
  <meta name="description" content="Simule um empr√©stimo em segundos: valor, taxa de juros, prazo e custos. Veja parcela, total pago, juros e tabela de amortiza√ß√£o (Price). Gratuito e responsivo." />
  <meta name="robots" content="index,follow" />
  <meta property="og:title" content="Simulador de Empr√©stimo Online ‚Äî Parcelas, Juros e Tabela (Price)" />
  <meta property="og:description" content="Calcule parcela, total pago, juros e gere a tabela de amortiza√ß√£o. Funciona no celular e no PC." />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#0b1220" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --line: rgba(255,255,255,.12);
      --brand: #6ee7ff;
      --brand2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --max: 1120px;
      --ring: 0 0 0 4px rgba(110,231,255,.18);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --panel: rgba(10,12,16,.06);
        --panel2: rgba(10,12,16,.08);
        --txt: rgba(10,12,16,.92);
        --muted: rgba(10,12,16,.68);
        --line: rgba(10,12,16,.12);
        --shadow: 0 18px 45px rgba(16,24,40,.16);
        --ring: 0 0 0 4px rgba(2,132,199,.15);
      }
    }

    *{ box-sizing: border-box; }
    html,body{ height: 100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 650px at 10% 10%, rgba(110,231,255,.22), transparent 60%),
        radial-gradient(900px 520px at 85% 18%, rgba(167,139,250,.20), transparent 55%),
        radial-gradient(900px 520px at 55% 110%, rgba(52,211,153,.12), transparent 60%),
        var(--bg);
      color: var(--txt);
      line-height: 1.45;
    }

    a{ color: inherit; text-decoration: none; }
    .wrap{ max-width: var(--max); margin: 0 auto; padding: 24px; }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px; margin-bottom: 18px;
    }
    .brand{
      display:flex; align-items:center; gap: 12px;
    }
    .logo{
      width: 42px; height: 42px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(110,231,255,.9), rgba(167,139,250,.9));
      box-shadow: 0 14px 34px rgba(0,0,0,.25);
      position: relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 35%);
      transform: rotate(12deg);
    }
    .titlebox h1{
      font-size: 16px; margin:0; font-weight: 700; letter-spacing: .2px;
    }
    .titlebox p{
      margin:2px 0 0 0; font-size: 12.5px; color: var(--muted);
    }

    .actions{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; justify-content: flex-end;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      font-size: 12.5px;
      color: var(--muted);
      backdrop-filter: blur(10px);
    }
    .btn{
      appearance: none; border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
      transition: transform .04s ease, background .2s ease, border-color .2s ease;
      backdrop-filter: blur(10px);
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.20), rgba(167,139,250,.18));
    }
    .btn:focus{ outline:none; box-shadow: var(--ring); }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 18px 18px 10px 18px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items: flex-start; justify-content: space-between; gap: 10px;
      background: rgba(255,255,255,.03);
    }
    .card .hd h2{ margin:0; font-size: 15px; font-weight: 800; letter-spacing:.2px;}
    .card .hd .sub{ margin:4px 0 0 0; font-size: 12.5px; color: var(--muted); max-width: 60ch;}
    .card .bd{ padding: 16px 18px 18px 18px; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 640px){
      .form{ grid-template-columns: 1fr; }
    }

    .field label{
      display:block;
      font-size: 12.5px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .input{
      display:flex; align-items:center;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 12px;
      gap: 10px;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .input:focus-within{ box-shadow: var(--ring); border-color: rgba(110,231,255,.35); background: rgba(255,255,255,.07); }
    .prefix{
      font-family: var(--mono);
      font-size: 12.5px;
      color: var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    input, select{
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      color: var(--txt);
      font-size: 14px;
      font-weight: 600;
    }
    input::placeholder{ color: rgba(255,255,255,.40); }
    @media (prefers-color-scheme: light){
      input::placeholder{ color: rgba(10,12,16,.40); }
    }

    .row{
      display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; align-items:center;
    }
    .note{
      font-size: 12.5px;
      color: var(--muted);
      margin-top: 10px;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }
    .dot{ width: 8px; height: 8px; border-radius: 99px; background: var(--good); }

    .metrics{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .metrics{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .metrics{ grid-template-columns: 1fr; }
    }
    .metric{
      padding: 14px 14px;
      border-radius: var(--radius2);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .metric .k{ font-size: 12.5px; color: var(--muted); margin: 0 0 6px 0; }
    .metric .v{ font-size: 20px; font-weight: 800; margin:0; letter-spacing: .2px; }
    .metric .mini{ font-size: 12.5px; color: var(--muted); margin: 6px 0 0 0; }

    .split{
      display:flex; align-items:center; justify-content: space-between;
      gap: 10px; margin-top: 12px;
      flex-wrap: wrap;
    }

    .tablewrap{
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead th{
      text-align:left;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      color: var(--muted);
      font-weight: 700;
      background: rgba(255,255,255,.03);
      position: sticky; top: 0;
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    tbody tr:hover{ background: rgba(255,255,255,.04); }
    .right{ text-align:right; font-variant-numeric: tabular-nums; }
    .mono{ font-family: var(--mono); font-variant-numeric: tabular-nums; }
    .scroll{
      max-height: 380px;
      overflow:auto;
    }

    .seo{
      margin-top: 16px;
      padding: 18px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .seo h3{ margin:0 0 8px 0; font-size: 14px; }
    .seo p{ margin: 8px 0; color: var(--muted); font-size: 13px; }
    .seo ul{ margin: 10px 0 0 18px; color: var(--muted); font-size: 13px; }
    footer{
      margin: 18px 0 10px 0;
      color: var(--muted);
      font-size: 12.5px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ‚ÄúEspa√ßo de an√∫ncio‚Äù (placeholder) */
    .ad{
      border: 1px dashed rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.10), rgba(167,139,250,.08));
      border-radius: var(--radius2);
      padding: 14px;
      color: var(--muted);
      font-size: 12.5px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .ad strong{ color: var(--txt); }
  </style>

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"SoftwareApplication",
    "name":"Simulador de Empr√©stimo Online",
    "applicationCategory":"FinanceApplication",
    "operatingSystem":"Web",
    "offers":{"@type":"Offer","price":"0","priceCurrency":"BRL"},
    "description":"Simule empr√©stimo com parcelas fixas (Price), total pago, juros e tabela de amortiza√ß√£o."
  }
  </script>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="titlebox">
          <h1>Simulador de Empr√©stimo (Price)</h1>
          <p>Parcela fixa, total pago, juros e tabela de amortiza√ß√£o ‚Äî gratuito</p>
        </div>
      </div>

      <div class="actions">
        <span class="chip" title="Tudo roda no seu navegador ‚Äî sem back-end">
          <span aria-hidden="true">‚ö°</span> 100% front-end
        </span>
        <button class="btn" id="btnExample" type="button">Carregar exemplo</button>
        <button class="btn" id="btnReset" type="button">Limpar</button>
        <button class="btn primary" id="btnCalc" type="button">Calcular</button>
      </div>
    </header>

    <div class="grid">
      <section class="card" aria-label="Formul√°rio do simulador">
        <div class="hd">
          <div>
            <h2>Dados do empr√©stimo</h2>
            <p class="sub">Preencha os campos e clique em ‚ÄúCalcular‚Äù. Mostramos a parcela fixa (Price), totais e a tabela m√™s a m√™s.</p>
          </div>
          <span class="badge"><span class="dot" aria-hidden="true"></span><span>Resultados instant√¢neos</span></span>
        </div>

        <div class="bd">
          <form class="form" id="loanForm" autocomplete="off">
            <div class="field">
              <label for="principal">Valor do empr√©stimo</label>
              <div class="input">
                <span class="prefix">R$</span>
                <input id="principal" inputmode="decimal" placeholder="Ex: 10000" value="10000" />
              </div>
            </div>

            <div class="field">
              <label for="rate">Taxa de juros</label>
              <div class="input">
                <span class="prefix">% ao m√™s</span>
                <input id="rate" inputmode="decimal" placeholder="Ex: 2.5" value="2.5" />
              </div>
            </div>

            <div class="field">
              <label for="months">Prazo</label>
              <div class="input">
                <span class="prefix">meses</span>
                <input id="months" inputmode="numeric" placeholder="Ex: 24" value="24" />
              </div>
            </div>

            <div class="field">
              <label for="fee">Custo/Taxa inicial (opcional)</label>
              <div class="input">
                <span class="prefix">R$</span>
                <input id="fee" inputmode="decimal" placeholder="Ex: 0" value="0" />
              </div>
            </div>

            <div class="field">
              <label for="start">Data inicial (opcional)</label>
              <div class="input">
                <span class="prefix">üìÖ</span>
                <input id="start" type="date" />
              </div>
            </div>

            <div class="field">
              <label for="rounding">Arredondamento</label>
              <div class="input">
                <span class="prefix">modo</span>
                <select id="rounding">
                  <option value="centavos" selected>Centavos (padr√£o)</option>
                  <option value="inteiro">Inteiro (R$)</option>
                </select>
              </div>
            </div>
          </form>

          <div class="row">
            <button class="btn primary" id="btnCalc2" type="button">Calcular agora</button>
            <button class="btn" id="btnCopy" type="button">Copiar link com par√¢metros</button>
            <button class="btn" id="btnCSV" type="button">Baixar tabela (CSV)</button>
          </div>

          <p class="note">
            Observa√ß√£o: este simulador usa o sistema <strong>Price</strong> (parcela fixa).
            Resultados s√£o estimativas e n√£o substituem proposta/contrato da institui√ß√£o.
          </p>

          <div class="seo" aria-label="Conte√∫do explicativo">
            <h3>Como funciona a parcela fixa (Price)?</h3>
            <p>
              No sistema Price, a <strong>parcela tende a ser constante</strong> ao longo do tempo.
              No in√≠cio, voc√™ paga mais juros e menos amortiza√ß√£o; com o passar dos meses, os juros caem e a amortiza√ß√£o aumenta.
            </p>
            <p>
              Se a taxa for 0% ao m√™s, a parcela vira simplesmente <strong>valor / meses</strong>.
            </p>
            <ul>
              <li><strong>Valor (principal):</strong> quanto voc√™ pega emprestado.</li>
              <li><strong>Taxa ao m√™s:</strong> juros mensais em porcentagem.</li>
              <li><strong>Prazo:</strong> n√∫mero de parcelas.</li>
              <li><strong>Taxa inicial:</strong> custo √∫nico somado ao custo total (opcional).</li>
            </ul>
          </div>
        </div>
      </section>

      <aside class="card" aria-label="Resultados">
        <div class="hd">
          <div>
            <h2>Resultado</h2>
            <p class="sub">Parcela, custo total, juros totais e uma tabela completa de amortiza√ß√£o.</p>
          </div>
        </div>

        <div class="bd">
          <div class="metrics" id="metrics">
            <div class="metric">
              <p class="k">Parcela mensal (estimada)</p>
              <p class="v" id="mPayment">‚Äî</p>
              <p class="mini" id="mPaymentHint">Preencha e calcule</p>
            </div>
            <div class="metric">
              <p class="k">Total pago</p>
              <p class="v" id="mTotal">‚Äî</p>
              <p class="mini" id="mTotalHint">Inclui taxa inicial se houver</p>
            </div>
            <div class="metric">
              <p class="k">Juros totais</p>
              <p class="v" id="mInterest">‚Äî</p>
              <p class="mini" id="mInterestPct">‚Äî</p>
            </div>
            <div class="metric">
              <p class="k">Custo inicial</p>
              <p class="v" id="mFee">‚Äî</p>
              <p class="mini" id="mMeta">‚Äî</p>
            </div>
          </div>

          <div class="split">
            <div class="badge" title="Dica: conte√∫do + ferramenta ajuda muito no Google">
              <span aria-hidden="true">üîé</span>
              <span>SEO-friendly</span>
            </div>
            <div class="badge" title="Export√°vel para planilha">
              <span aria-hidden="true">üìÑ</span>
              <span>CSV pronto</span>
            </div>
          </div>

          <div style="margin-top:14px" class="ad" aria-label="Espa√ßo de an√∫ncio">
            <div>
              <strong>Espa√ßo para an√∫ncio</strong>
              <div style="margin-top:4px">Depois voc√™ pode inserir AdSense aqui (sem alterar o simulador).</div>
            </div>
            <span class="mono">728√ó90</span>
          </div>

          <div class="tablewrap" style="margin-top:14px">
            <div class="scroll" role="region" aria-label="Tabela de amortiza√ß√£o com rolagem">
              <table aria-describedby="tableDesc">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Data</th>
                    <th class="right">Parcela</th>
                    <th class="right">Juros</th>
                    <th class="right">Amortiza√ß√£o</th>
                    <th class="right">Saldo</th>
                  </tr>
                </thead>
                <tbody id="tbody">
                  <tr>
                    <td colspan="6" style="padding:14px; color: rgba(255,255,255,.65);">
                      Calcule para ver a tabela.
                    </td>
                  </tr>
                </tbody>
              </table>
              <div id="tableDesc" class="note" style="padding: 12px 12px 14px 12px; margin:0;">
                A tabela mostra m√™s a m√™s a divis√£o entre juros, amortiza√ß√£o e saldo devedor.
              </div>
            </div>
          </div>

        </div>
      </aside>
    </div>

    <footer>
      <div>Feito para rodar 100% no navegador. Nenhum dado √© enviado para servidor.</div>
      <div class="mono">v1.0 ‚Ä¢ Price (parcela fixa)</div>
    </footer>
  </div>

  <script>
    (function(){
      "use strict";

      const el = (id) => document.getElementById(id);

      const principalEl = el("principal");
      const rateEl = el("rate");
      const monthsEl = el("months");
      const feeEl = el("fee");
      const startEl = el("start");
      const roundingEl = el("rounding");

      const mPayment = el("mPayment");
      const mTotal = el("mTotal");
      const mInterest = el("mInterest");
      const mInterestPct = el("mInterestPct");
      const mFee = el("mFee");
      const mMeta = el("mMeta");
      const tbody = el("tbody");

      const btnCalc = el("btnCalc");
      const btnCalc2 = el("btnCalc2");
      const btnReset = el("btnReset");
      const btnExample = el("btnExample");
      const btnCSV = el("btnCSV");
      const btnCopy = el("btnCopy");

      const brl = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });

      function parseNumberLoose(v){
        if (typeof v !== "string") v = String(v ?? "");
        v = v.trim();
        if (!v) return NaN;
        // Aceita "10.000,50" ou "10000.50" ou "10000,50"
        v = v.replace(/\s/g, "");
        // remove moeda e outros
        v = v.replace(/[R$\u00A0]/g, "");
        // se tiver v√≠rgula, assume decimal pt-BR
        if (v.includes(",")){
          v = v.replace(/\./g, "").replace(",", ".");
        }
        // mant√©m s√≥ n√∫meros, ponto e sinal
        v = v.replace(/[^0-9.\-]/g, "");
        return Number(v);
      }

      function roundMoney(x, mode){
        if (!isFinite(x)) return x;
        if (mode === "inteiro") return Math.round(x);
        return Math.round(x * 100) / 100;
      }

      function toISODate(d){
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function addMonths(date, m){
        const d = new Date(date.getTime());
        const day = d.getDate();
        d.setMonth(d.getMonth() + m);
        // Ajuste simples para meses com menos dias:
        if (d.getDate() < day) d.setDate(0);
        return d;
      }

      function calcPMT(P, r, n){
        // PMT = P*r*(1+r)^n / ((1+r)^n - 1)
        if (n <= 0) return NaN;
        if (Math.abs(r) < 1e-12) return P / n;
        const a = Math.pow(1 + r, n);
        return P * r * a / (a - 1);
      }

      function buildSchedule({P, r, n, fee, startDate, roundingMode}){
        const pmtRaw = calcPMT(P, r, n);
        const pmt = roundMoney(pmtRaw, roundingMode);

        let balance = P;
        let totalPaid = 0;
        let totalInterest = 0;

        const rows = [];

        for (let i = 1; i <= n; i++){
          const interestRaw = balance * r;
          let interest = roundMoney(interestRaw, roundingMode);

          // Para evitar saldo negativo por arredondamento:
          let principalPay = roundMoney(pmt - interest, roundingMode);

          if (i === n){
            // Ajuste final: quita tudo no √∫ltimo m√™s (evita centavos sobrando)
            principalPay = roundMoney(balance, roundingMode);
            interest = roundMoney(pmt - principalPay, roundingMode);
          }

          balance = roundMoney(balance - principalPay, roundingMode);
          if (balance < 0) balance = 0;

          totalPaid += pmt;
          totalInterest += interest;

          const dateStr = startDate ? formatBRDate(addMonths(startDate, i)) : "‚Äî";

          rows.push({
            i,
            dateStr,
            payment: pmt,
            interest,
            principal: principalPay,
            balance
          });
        }

        const totalWithFee = roundMoney(totalPaid + fee, roundingMode);

        return {
          payment: pmt,
          totalPaid: roundMoney(totalPaid, roundingMode),
          totalWithFee,
          totalInterest: roundMoney(totalInterest, roundingMode),
          rows
        };
      }

      function formatBRDate(d){
        // dd/mm/aaaa
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      function setError(msg){
        tbody.innerHTML = `<tr><td colspan="6" style="padding:14px;color:rgba(255,255,255,.72)">${escapeHtml(msg)}</td></tr>`;
        mPayment.textContent = "‚Äî";
        mTotal.textContent = "‚Äî";
        mInterest.textContent = "‚Äî";
        mInterestPct.textContent = "‚Äî";
        mFee.textContent = "‚Äî";
        mMeta.textContent = "‚Äî";
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, (c)=>({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
        }[c]));
      }

      function calculate(){
        const P = parseNumberLoose(principalEl.value);
        const ratePct = parseNumberLoose(rateEl.value);
        const n = Math.floor(parseNumberLoose(monthsEl.value));
        const fee = Math.max(0, parseNumberLoose(feeEl.value) || 0);
        const roundingMode = roundingEl.value;

        let startDate = null;
        if (startEl.value){
          const [y,m,d] = startEl.value.split("-").map(Number);
          if (y && m && d) startDate = new Date(y, m-1, d);
        }

        if (!isFinite(P) || P <= 0) return setError("Informe um valor de empr√©stimo v√°lido (maior que zero).");
        if (!isFinite(ratePct) || ratePct < 0) return setError("Informe uma taxa de juros v√°lida (0 ou maior).");
        if (!isFinite(n) || n <= 0 || n > 600) return setError("Informe um prazo v√°lido (1 a 600 meses).");

        const r = ratePct / 100;

        const result = buildSchedule({P, r, n, fee, startDate, roundingMode});

        // M√©tricas
        mPayment.textContent = brl.format(result.payment);
        mTotal.textContent = brl.format(result.totalWithFee);
        mInterest.textContent = brl.format(result.totalInterest);
        mFee.textContent = brl.format(roundMoney(fee, roundingMode));

        const interestPct = (result.totalInterest / P) * 100;
        mInterestPct.textContent = isFinite(interestPct) ? `${interestPct.toFixed(2)}% do valor emprestado` : "‚Äî";

        const meta = [];
        meta.push(`${n} meses`);
        meta.push(`${ratePct.toFixed(4).replace(/\.?0+$/,"")} % a.m.`);
        mMeta.textContent = meta.join(" ‚Ä¢ ");

        // Tabela
        tbody.innerHTML = result.rows.map(rw => `
          <tr>
            <td class="mono">${rw.i}</td>
            <td class="mono">${escapeHtml(rw.dateStr)}</td>
            <td class="right">${brl.format(rw.payment)}</td>
            <td class="right">${brl.format(rw.interest)}</td>
            <td class="right">${brl.format(rw.principal)}</td>
            <td class="right">${brl.format(rw.balance)}</td>
          </tr>
        `).join("");

        // Atualiza URL com par√¢metros (para compartilhar)
        const url = new URL(window.location.href);
        url.searchParams.set("v", String(P));
        url.searchParams.set("t", String(ratePct));
        url.searchParams.set("n", String(n));
        url.searchParams.set("f", String(fee));
        if (startEl.value) url.searchParams.set("d", startEl.value); else url.searchParams.delete("d");
        url.searchParams.set("r", roundingMode);
        window.history.replaceState({}, "", url);
      }

      function loadFromQuery(){
        const q = new URLSearchParams(window.location.search);
        const v = q.get("v");
        const t = q.get("t");
        const n = q.get("n");
        const f = q.get("f");
        const d = q.get("d");
        const r = q.get("r");

        if (v) principalEl.value = v;
        if (t) rateEl.value = t;
        if (n) monthsEl.value = n;
        if (f) feeEl.value = f;
        if (d) startEl.value = d;
        if (r) roundingEl.value = r;
      }

      function reset(){
        principalEl.value = "10000";
        rateEl.value = "2.5";
        monthsEl.value = "24";
        feeEl.value = "0";
        roundingEl.value = "centavos";
        startEl.value = "";
        const url = new URL(window.location.href);
        url.search = "";
        window.history.replaceState({}, "", url);
        setError("Calcule para ver a tabela.");
      }

      function loadExample(){
        principalEl.value = "25000";
        rateEl.value = "1.89";
        monthsEl.value = "36";
        feeEl.value = "350";
        // Data inicial: hoje
        const now = new Date();
        startEl.value = toISODate(now);
        roundingEl.value = "centavos";
        calculate();
      }

      function downloadCSV(){
        // Gera CSV a partir da tabela atual
        const rows = Array.from(tbody.querySelectorAll("tr"));
        if (!rows.length || rows[0].children.length < 6) return;

        const header = ["Parcela","Data","Pagamento","Juros","Amortiza√ß√£o","Saldo"];
        const data = [header.join(";")];

        for (const tr of rows){
          const tds = Array.from(tr.querySelectorAll("td")).map(td => td.innerText.trim());
          if (tds.length !== 6) continue;
          data.push(tds.join(";"));
        }

        const blob = new Blob([data.join("\n")], { type: "text/csv;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "tabela_amortizacao.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
      }

      async function copyLink(){
        try{
          await navigator.clipboard.writeText(window.location.href);
          btnCopy.textContent = "Link copiado ‚úÖ";
          setTimeout(()=>btnCopy.textContent = "Copiar link com par√¢metros", 1400);
        }catch{
          // fallback
          const inp = document.createElement("input");
          inp.value = window.location.href;
          document.body.appendChild(inp);
          inp.select();
          document.execCommand("copy");
          inp.remove();
          btnCopy.textContent = "Link copiado ‚úÖ";
          setTimeout(()=>btnCopy.textContent = "Copiar link com par√¢metros", 1400);
        }
      }

      // Eventos
      btnCalc.addEventListener("click", calculate);
      btnCalc2.addEventListener("click", calculate);
      btnReset.addEventListener("click", reset);
      btnExample.addEventListener("click", loadExample);
      btnCSV.addEventListener("click", downloadCSV);
      btnCopy.addEventListener("click", copyLink);

      // Calcular ao pressionar Enter em inputs
      ["principal","rate","months","fee","start"].forEach(id=>{
        el(id).addEventListener("keydown", (e)=>{
          if (e.key === "Enter"){
            e.preventDefault();
            calculate();
          }
        });
      });

      // Inicializa√ß√£o
      loadFromQuery();
      setError("Calcule para ver a tabela.");
      // Se j√° vier com query completa, calcula
      const hasParams = new URLSearchParams(window.location.search).toString().length > 0;
      if (hasParams) calculate();
    })();
  </script>
</body>
</html>
